<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vue Beginners.</title>
    <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 5%;
            font-family: 'Quicksand', sans-serif;
        }

        .active {
            background: salmon;
            border: 0;
            padding: 5px
        }

        .error {
            color: red;
        }

        .input-group {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

<div id="app">
    <header-component nama="Vuejs" gambar="https://vuejs.org/images/logo.png"></header-component>
    <nav>
        <router-link to ="/">Home</router-link>
        <router-link to ="/about">About</router-link>
        <router-link to ="/kelas">Kelas</router-link>
    </nav>

    <main>
        <router-view v-bind:items="kelas" v-on:submitkelas="submitkelas" v-on:hapuskelas="hapuskelas"></router-view>
    </main>
    <footer-component>
        <p>copyright 2025 - kelas.daffaReyhansyah</p>
    </footer-component>

</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2.6.8"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-router@3.0.2/dist/vue-router.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.23.0/firebase-database.js"></script>
<script>
  
// TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBQRYIqi9MGhsd6K9y2v4JHa9XN8oHZQOE",
    authDomain: "tutorial-vuejs-2becd.firebaseapp.com",
    projectId: "tutorial-vuejs-2becd",
    storageBucket: "tutorial-vuejs-2becd.firebasestorage.app",
    messagingSenderId: "1068237921098",
    appId: "1:1068237921098:web:7f1ab961e02a8675f67fb3",
    databaseURL:"https://tutorial-vuejs-2becd-default-rtdb.asia-southeast1.firebasedatabase.app"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const database = firebase.database()
  const kelasRef = database.ref('kelas');

    const Home = {
        template: `<div>Home</div>`
    }

    const About = {
        template: `<div>About</div>`
    }

    const NotFound = {
        template: `<div>404 Not Found</div>`
    }

    const detailKelas = {
        template: `<div>
            <img v-if="detailKelas.gambar" :src="url_gambar(detailKelas.gambar)" width="200" />
            <div v-else style="width:200px; height:150px; background:#f0f0f0; display:flex; align-items:center; justify-content:center;">
                <span>No Image</span>
            </div>
            <h3>{{detailKelas.judul}} - {{$route.params.idkelas}}</h3>
            <p>{{detailKelas.deskripsi}}</p>
            <router-link to="/kelas">Kembali ke daftar kelas</router-link>
        </div>`,
        data() {
            return {
                detailKelas: {}
            }
            },
            created() {
                this.filterkelas()
        },
        methods:{
            filterkelas(){
                // Get from Firebase data instead of localStorage
                const parent = this.$parent;
                let id = this.$route.params.idkelas;
                let item = parent.kelas.find(k => k.id === id);
                this.detailKelas = item || {};
            },
            url_gambar: function(gambar) {
                return '/image/' + gambar
            }
        }
    }

    const Kelas = {
        props: ['items',],
        template: `
            <div>
            <h3>Tambah Kelas.</h3>
            <form v-on:submit.prevent="submitkelas" >
            <div class="input-group">
                <input type="text" v-model="kelas.judul" placeholder="Nama Kelas">
                <div class="error" v-if="error.judul"><small>{{error.judul}}</small></div>
            </div>


            <div class="input-group">
                <label>Deskripsi: </label> <br>
                <textarea v-model="kelas.deskripsi"></textarea>
                <div class="error" v-if="error.deskripsi"><small>{{error.deskripsi}}</small></div>
            </div>

            <div class="input-group">
                <p><img :src="previewimg" v-if="previewimg" width="100" /></p>
                <label>Masukkan Gambar</label> <br>
                <input type="file" ref="gambar" v-on:change="upload" />
            </div>
            <button type="submit">Submit</button>
        </form>
            <hr>
            <h3>Daftar Kelas({{items.length}})</h3>

            <template v-if="items.length">
                <ul>
                    <li v-for="(item, index) of items" :key="item.id">
                        <div v-if="item.gambar" style="display:inline-block;">
                            <img :src="'/image/' + item.gambar" width="100" />
                        </div>
                        <div v-else style="width:100px; height:75px; background:#f0f0f0; display:inline-flex; align-items:center; justify-content:center;">
                            <span style="font-size:12px;">No Image</span>
                        </div>
                        <p>{{index+1}} - {{item.judul}}
                        <a href="" v-on:click.prevent="$emit('hapuskelas', item.id)">hapus</a>
                        <router-link :to="'/kelas/' + item.id">Lihat kelas</router-link>
                        </p>
                    </li>
                </ul>
            </template>

            <li v-else>Kelas belum tersedia..</li>
            </div>
            `,
        data: function () {
            return {
                kelas:{
                    judul: "",
                    deskripsi: "",
                    gambar: ""
                },
                previewimg: "",
                error: {
                    judul:'',
                    deskripsi: '',
                }
            }
        },
        methods: {
            submitkelas: function(){
                this.error.judul = '';
                this.error.deskripsi = '';

                if (this.kelas.judul == '') {
                    this.error.judul = "Judul kelas harus diisi";
                }
                if (this.kelas.deskripsi == '') {
                    this.error.deskripsi = "Deskripsi kelas harus diisi";
                }

                if(this.kelas.judul && this.kelas.deskripsi) {
                    const data = {
                    id: uuid.v4(),
                    judul: this.kelas.judul,
                    deskripsi: this.kelas.deskripsi,
                    gambar: this.kelas.gambar || null // Handle undefined gambar
                }
                this.$emit('submitkelas', data);

                this.kelas.judul = "";
                this.kelas.deskripsi = "";
                this.kelas.gambar = "";
                this.previewimg = "";
                this.$refs.gambar.value = ""
                }
            },
            upload: function(event){
                const file = event.target.files[0];
                if (file) {
                    this.kelas.gambar = file.name; // Store filename instead of file object
                    this.previewimg = URL.createObjectURL(file);
                }
            }
        }
    }
    Vue.component('header-component', {
        props: ['nama', 'gambar'],
        template: `
            <header>
                <img :src="gambar" width="300">
                <p>{{ 'Hello, ' + nama}}</p>
            </header>
            `,
        data: function () {
            return {
                pesan: 'Hello, Component!',
            }
        }
    })

    Vue.component('footer-component', {
        template: `
            <footer>
                <slot></slot>
            </footer>
            `
    })

    const routes = [
        {path: '/', component: Home},
        {path: '/about', component: About},
        {path: '/kelas', component: Kelas},
        {
            path: '/kelas/:idkelas',
            component: detailKelas
        },
        {path: '*', component: NotFound},

    ]
    const router = new VueRouter({
        mode: 'history',
        routes
    })


    const vm = new Vue({
        router,
        components: {
            'home': Home
        },
        data: {
            kelas: []
        },

        created: function() {
            kelasRef.on('value', this.resultData, this.errorData)
            },
            beforeCreate () {
                console.log('beforeCreate')
            },
            mounted () {
                console.log('mounted')
            },
            beforeupdate () {
                console.log('beforeUpdate')
            },
            updated () {
                console.log('updated')
            },
        methods: {
            resultData(snapshot){
                this.kelas = []; // Clear existing data first
                const data = snapshot.val();
                if (data) {
                    // Convert Firebase object to array
                    Object.keys(data).forEach(key => {
                        this.kelas.push({
                            ...data[key],
                            firebaseKey: key // Store Firebase key for updates/deletes
                        });
                    });
                }
            },
            errorData(error){
                console.log('Firebase error:', error)
            },
            hapuskelas: function (id) {
                // Find item with Firebase key
                const item = this.kelas.find(k => k.id === id);
                if (item && item.firebaseKey) {
                    // Delete from Firebase
                    kelasRef.child(item.firebaseKey).remove()
                        .then(() => {
                            swal({
                                text: "Kelas berhasil dihapus!",
                                icon: "success",
                            });
                        })
                        .catch(error => {
                            console.error('Error deleting:', error);
                            swal({
                                text: "Error menghapus kelas!",
                                icon: "error",
                            });
                        });
                }
            },
            submitkelas: function (data) {
                // Save to Firebase instead of localStorage
                kelasRef.push(data)
                    .then(() => {
                        swal({
                            title: data.judul,
                            text: "Kelas berhasil ditambahkan!",
                            icon: "success",
                        });
                    })
                    .catch(error => {
                        console.error('Error saving:', error);
                        swal({
                            text: "Error menambahkan kelas!",
                            icon: "error",
                        });
                    });
            }
        },
        computed: {}
    })

    vm.$mount('#app')
</script>
</body>
</html>